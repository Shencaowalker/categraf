# Read metrics from one or many postgresql servers
# # collect interval
# interval = 15

[[instances]]
  ## specify address via a url matching:
  ##   postgres://[pqgotest[:password]]@localhost[/dbname]?sslmode=[disable|verify-ca|verify-full]
  ## or a simple string:
  ##   host=localhost user=pqgotest password=... sslmode=... dbname=app_production
  ##
  ## All connection parameters are optional.
  ##
  ## Without the dbname parameter, the driver will default to a database
  ## with the same name as the user. This dbname is just for instantiating a
  ## connection with the server and doesn't restrict the databases we are trying
  ## to grab metrics for.
  ##
  # address = "host=localhost user=postgres sslmode=disable"

  ## A custom name for the database that will be used as the "server" tag in the
  ## measurement output. If not specified, a default one generated from
  ## the connection address is used.
  # outputaddress = "db01"

  ## connection configuration.
  ## maxlifetime - specify the maximum lifetime of a connection.
  ## default is forever (0s)
  # max_lifetime = "0s"

  ## A  list of databases to explicitly ignore.  If not specified, metrics for all
  ## databases are gathered.  Do NOT use with the 'databases' option.
  # ignored_databases = ["postgres", "template0", "template1"]

  ## A list of databases to pull metrics about. If not specified, metrics for all
  ## databases are gathered.  Do NOT use with the 'ignored_databases' option.
  # databases = ["app_production", "testing"]

  ## Whether to use prepared statements when connecting to the database.
  ## This should be set to false when connecting through a PgBouncer instance
  ## with pool_mode set to transaction.
  #prepared_statements = true
  # [[instances.metrics]]
  # mesurement = "sessions"
  # label_fields = [ "status", "type" ]
  # metric_fields = [ "value" ]
  # timeout = "3s"
  # request = '''
  # SELECT status, type, COUNT(*) as value FROM v$session GROUP BY status, type
  # '''
  #
  # [[instances.metrics]]
  # mesurement = "sessions"
  # metric_fields = [ "active" ]
  # timeout = "3s"
  # request = '''
  # select count(*) as active from pg_stat_activity;
  # '''


[[instances]]
address="host=10.5.20.50 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "CAN ?~@?~O~Q?~N??~C 10.5.20.50"
ignored_databases = ["postgres", "template0", "template1"]
databases = [ "jscip","anymetrics","semantic","tse"]
#labels = { instance="big-dev:6379 " }

[[instances]]
address="host=10.161.37.51 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "BIG 测试环境 10.161.37.51"
ignored_databases = ["postgres", "template0", "template1"]
databases = ["semantic", "anymetrics","postgres"]

[[instances]]
address="host=10.161.73.134 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "BIG 集成测试环境 10.161.73.134"
ignored_databases = ["postgres", "template0", "template1"]
databases = ["semantic", "anymetrics","postgres"]

[[instances]]
address="host=10.5.100.3 user=postgres password=postgres sslmode=disable"
outputaddress = "BIG 开发环境 10.5.100.3"
ignored_databases = ["postgres", "template0", "template1"]
databases = ["semantic", "anymetrics","postgres"]


#[[instances]]
#address="host=10.5.70.11 user=aloudata password=aloudata123 sslmode=disable"
#outputaddress = " CHAOS 生产环境 10.5.70.11"
#ignored_databases = ["postgres", "template0", "template1"]
#databases = ["chaos_prod"]

#[[instances]]
#address="host=10.16.0.167 user=aloudata password=aloudata123 sslmode=disable"
#outputaddress = "CAN 公有云体验环境 10.16.0.167"
#ignored_databases = ["postgres", "template0", "template1"]
#databases = [ "jscip","anymetrics","semantic","tse"]


[[instances]]
address="host=10.161.213.146 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "CAN 集成测试环境 10.161.213.146"
ignored_databases = ["postgres", "template0", "template1"]
databases = [ "jscip","anymetrics","semantic","tse"]

[[instances]]
address="host=10.161.41.230 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "CAN 测试环境 10.161.41.230"
ignored_databases = ["postgres", "template0", "template1"]
databases = [ "jscip","anymetrics","semantic","tse"]

[[instances]]
address="host=10.5.20.50 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "CAN 开发环境 10.5.20.50"
ignored_databases = ["postgres", "template0", "template1"]
databases = [ "jscip","anymetrics","semantic","tse"]

[[instances]]
address="host=10.161.34.21 user=aloudata password=aloudata123 sslmode=disable"
outputaddress = "chaos专用指标平台环境 10.161.34.21"
ignored_databases = ["postgres", "template0", "template1"]
databases = [ "jscip","anymetrics","semantic","tse"]
[[instances]]
address="host=10.5.100.113 user=postgres password=postgres dbname=bigmetademonew sslmode=disable"
outputaddress = "BIG demo演示环境 10.5.100.113"
ignored_databases = ["postgres", "template0", "template1"]
databases = ["semantic", "anymetrics","bigmetademonew"]
[[instances.metrics]]
mesurement = "big_audit"
label_fields = [ "user_id", "user_behavior", "behavior_action", "behavior_result" ]
metric_fields = [ "values" ]
labels = {env="demo", project="big"}
timeout = "3s"
request = '''
SELECT user_id,user_behavior,behavior_action,behavior_result, COUNT(*) as values
FROM  bigmeta_user_behavior_log  
GROUP BY (user_id,user_behavior,behavior_action,behavior_result)
'''
[[instances.metrics]]
mesurement = "big_audit_count"
label_fields = [ "day_date"]
metric_fields = [ "daily_count" ]
labels = {env="demo", project="big"}
timeout = "3s"
request = '''
SELECT TO_CHAR(happen_time, 'YYYY-MM-DD') as day_date,COUNT(*) as daily_count
FROM bigmeta_user_behavior_log WHERE is_deleted = false
GROUP BY TO_CHAR(happen_time, 'YYYY-MM-DD') ORDER BY day_date;
'''
[[instances.metrics]]
mesurement = "slow"
label_fields = [ "datname","usename","query","query_start"]
metric_fields = [ "query_running_time_seconds" ]
labels = {env="demo", project="big"}
timeout = "5s"
request = '''
SELECT datname,usename,query,query_start,EXTRACT(EPOCH FROM (now() - query_start)) AS query_running_time_seconds
FROM pg_stat_activity
WHERE state = 'active'
  AND query_start IS NOT NULL
  AND query NOT LIKE '%pg_stat_activity%'
  AND now() - query_start > interval '5 seconds';
'''


[[instances]]
address="host=10.5.25.1 user=aloudata password=aloudata123 dbname=postgres sslmode=disable"
outputaddress = "dev-postgresql-master 10.5.25.1"
ignored_databases = ["postgres", "template0", "template1"]
databases = ["semantic", "anymetrics","bigmetademonew"]

[[instances.metrics]]
mesurement = "replication"
label_fields = [ "state","sync_state"]
metric_fields = [ "write_lag_ms","flush_lag_ms","replay_lag_ms" ]
labels = {env="test"}
timeout = "5s"
request = '''
SELECT 
    application_name,
    client_addr,
    state,
    sync_state,
    sent_lsn,
    replay_lsn,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn)) as sent_delay_pretty,
    pg_size_pretty(pg_wal_lsn_diff(sent_lsn, replay_lsn)) as replay_delay_pretty,
    ROUND(EXTRACT(EPOCH FROM write_lag) * 1000, 1) as write_lag_ms,
    ROUND(EXTRACT(EPOCH FROM flush_lag) * 1000, 1) as flush_lag_ms,
    ROUND(EXTRACT(EPOCH FROM replay_lag) * 1000, 1) as replay_lag_ms,
    backend_start,
    NOW() - backend_start as connection_duration
FROM pg_stat_replication
ORDER BY replay_lag_ms DESC NULLS LAST;
'''
